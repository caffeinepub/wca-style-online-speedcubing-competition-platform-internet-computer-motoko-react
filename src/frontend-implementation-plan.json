{
  "kind": "implementation_plan",
  "version": "1.0",
  "title": "WCA-style speedcubing competition platform (React frontend)",
  "requirements": [
    {
      "id": "REQ-1",
      "summary": "Add Internet Identity login UI, profile setup/edit (display name), and gate participation actions to authenticated users while keeping public competition browsing available.",
      "acceptanceCriteria": [
        "Unauthenticated users can browse public competition pages but cannot start a competition or submit solve results.",
        "On first login, a user profile is created for the caller Principal (if missing).",
        "A logged-in user can set/update their own display name; users cannot modify other users' profiles.",
        "All backend update calls that mutate user-specific data validate caller != anonymous and use caller Principal as the source of truth."
      ],
      "file_operations": [
        {
          "path": "frontend/src/App.tsx",
          "operation": "create",
          "description": "Create the root app shell: wire routing, render a top nav with login/logout controls using the existing Internet Identity hook, and ensure public browsing works without authentication while participation routes/actions require auth. Verify the component's usage instructions before implementing."
        },
        {
          "path": "frontend/src/components/auth/LoginButton.tsx",
          "operation": "create",
          "description": "Implement a login/logout button using the existing useInternetIdentity hook and clear React Query cache on logout (per selected authorization component guidance). Verify the component's usage instructions before implementing."
        },
        {
          "path": "frontend/src/hooks/useCurrentUserProfile.ts",
          "operation": "create",
          "description": "Add a React Query hook that fetches getCallerUserProfile via useActor, with correct loading state to avoid profile-setup modal flash (per selected authorization component guidance). Verify the component's usage instructions before implementing."
        },
        {
          "path": "frontend/src/components/profile/ProfileSetupDialog.tsx",
          "operation": "create",
          "description": "Add a modal dialog prompting for display name when authenticated and getCallerUserProfile returns null; call createUserProfile to create on first login, and provide saveCallerUserProfile to update later. Use shadcn-ui dialog/form primitives from frontend/src/components/ui (do not modify them). Verify the component's usage instructions before implementing."
        },
        {
          "path": "frontend/src/components/profile/ProfileMenu.tsx",
          "operation": "create",
          "description": "Add a small profile menu in the nav that shows the current display name and opens edit flow to update it via saveCallerUserProfile. Use shadcn-ui dropdown/menu primitives from frontend/src/components/ui (do not modify them). Verify the component's usage instructions before implementing."
        },
        {
          "path": "frontend/src/components/auth/RequireAuth.tsx",
          "operation": "create",
          "description": "Create a wrapper component that blocks child content unless the user is authenticated (identity present), rendering an access-denied/login prompt instead; reuse on start/solve/submit flows. Verify the component's usage instructions before implementing."
        }
      ]
    },
    {
      "id": "REQ-3",
      "summary": "Implement admin-only competition creation UI with fields for metadata and exactly 5 scrambles; non-admin users only see read-only competition info.",
      "acceptanceCriteria": [
        "Backend enforces admin authorization for create/update competition operations.",
        "Competition slug is unique across competitions (server-enforced).",
        "A competition always has exactly 5 scrambles (1–5) stored server-side.",
        "If participant limit is set, the backend prevents new starts once the limit is reached (based on number of started results)."
      ],
      "file_operations": [
        {
          "path": "frontend/src/components/auth/AdminGuard.tsx",
          "operation": "create",
          "description": "Create an admin-only UI guard that checks isCallerAdmin (or getCallerUserRole) via React Query and shows an Access Denied screen for non-admins; use it to protect admin routes. Verify the component's usage instructions before implementing."
        },
        {
          "path": "frontend/src/pages/admin/AdminCreateCompetitionPage.tsx",
          "operation": "create",
          "description": "Create an admin competition creation page with name, slug, start/end dates, status, optional participant limit, event identifier (for future multi-event support), and exactly 5 scramble inputs; submit via createCompetition and show success/error feedback. Use shadcn-ui form inputs/buttons/cards from frontend/src/components/ui (do not modify them). Verify the component's usage instructions before implementing."
        },
        {
          "path": "frontend/src/router.tsx",
          "operation": "create",
          "description": "Add route registration for the admin competition creation page and wrap it with AdminGuard so only admins can access it. Verify the component's usage instructions before implementing."
        },
        {
          "path": "frontend/src/components/competition/CompetitionCard.tsx",
          "operation": "create",
          "description": "Create a reusable competition summary card for lists (name, status, dates) and a link to the competition detail page. Use shadcn-ui card primitives from frontend/src/components/ui (do not modify them). Verify the component's usage instructions before implementing."
        }
      ]
    },
    {
      "id": "REQ-4",
      "summary": "Implement competition intro page with Start Competition action that is available only once per user and routes into the solve flow at the correct attempt based on current result status.",
      "acceptanceCriteria": [
        "If a user has not started, the UI shows a Start action; once started, the UI routes to the solve flow at the correct current attempt.",
        "Repeated Start requests are idempotent: they do not create duplicates and do not reset state.",
        "A completed result cannot be reopened for additional attempts."
      ],
      "file_operations": [
        {
          "path": "frontend/src/pages/CompetitionDetailPage.tsx",
          "operation": "create",
          "description": "Create a competition intro/detail page that fetches competition data, shows status/dates/scrambles policy, and conditionally shows a Start Competition button (auth-required) that calls startCompetition and then routes to the solve flow. Verify the component's usage instructions before implementing."
        },
        {
          "path": "frontend/src/hooks/useCompetition.ts",
          "operation": "create",
          "description": "Add React Query hooks for getCompetition and getCompetitions, shared by list/detail pages; keep query keys stable for future expansion. Verify the component's usage instructions before implementing."
        },
        {
          "path": "frontend/src/hooks/useMyCompetitionResult.ts",
          "operation": "create",
          "description": "Add a React Query hook that derives the caller's current result state for a competition from getResults and the authenticated principal (from useInternetIdentity), used to decide whether Start is available and which attempt to resume. Verify the component's usage instructions before implementing."
        },
        {
          "path": "frontend/src/router.tsx",
          "operation": "modify",
          "description": "Wire the competition detail page into navigation and ensure the Start action routes to the solve flow route for the same competition. Verify the component's usage instructions before implementing."
        }
      ]
    },
    {
      "id": "REQ-5",
      "summary": "Build the 5-attempt solve flow UI: inspection with scramble reveal, penalty logic, client-side solve timer, sequential submission, no backtracking, and completion screen.",
      "acceptanceCriteria": [
        "The UI enforces the sequence: inspection starts -> scramble revealed -> solve timer -> stop -> submission -> advance; previous scrambles cannot be revisited in the UI.",
        "Penalty is determined and displayed based on inspection duration: none (<15s), +2 (15–17s), DNF (>17s).",
        "Each attempt submission calls a backend method that validates the expected attempt index and rejects out-of-order or duplicate submissions.",
        "After attempt 5 is submitted, the backend marks the result completed and the UI shows a completion screen (no further timing controls)."
      ],
      "file_operations": [
        {
          "path": "frontend/src/pages/SolveFlowPage.tsx",
          "operation": "create",
          "description": "Create the solve flow page for a single competition: fetch competition + caller result state, determine current attempt index, enforce forward-only progression, and orchestrate inspection -> solve -> submitAttempt -> advance until done. Verify the component's usage instructions before implementing."
        },
        {
          "path": "frontend/src/components/solve/InspectionTimer.tsx",
          "operation": "create",
          "description": "Implement a 15-second inspection timer component that keeps scramble hidden until inspection starts, reveals scramble during inspection, and outputs the penalty decision (none/+2/DNF) based on elapsed inspection time. Verify the component's usage instructions before implementing."
        },
        {
          "path": "frontend/src/components/solve/SolveTimer.tsx",
          "operation": "create",
          "description": "Implement a client-side solve timer component with large typography, start/stop controls appropriate to the flow, and export of measured time for submission; ensure disabled/locked states after stop/submission. Verify the component's usage instructions before implementing."
        },
        {
          "path": "frontend/src/components/solve/SolveCompletionScreen.tsx",
          "operation": "create",
          "description": "Create a completion screen shown after attempt 5 submission (no timing controls), with navigation to the competition leaderboard and competition page. Verify the component's usage instructions before implementing."
        },
        {
          "path": "frontend/src/hooks/useSubmitAttempt.ts",
          "operation": "create",
          "description": "Add a React Query mutation hook wrapping submitAttempt with UI-friendly error mapping (unauthorized, invalid attempt, already completed/submitted), and invalidation of result/leaderboard queries on success. Verify the component's usage instructions before implementing."
        },
        {
          "path": "frontend/src/router.tsx",
          "operation": "modify",
          "description": "Register the solve flow route and ensure it is reachable only via proper in-app navigation (no UI links back to earlier attempts); wrap route with RequireAuth. Verify the component's usage instructions before implementing."
        }
      ]
    },
    {
      "id": "REQ-7",
      "summary": "Add a per-competition leaderboard UI that lists completed results only, computes Ao5, sorts, ranks, and paginates.",
      "acceptanceCriteria": [
        "Leaderboard excludes in-progress results.",
        "Ao5 calculation follows: remove best and worst of 5; average remaining 3; any DNF in counted solves results in DNF Ao5 (define and apply consistently).",
        "Results are sorted by Ao5 with DNFs ranked last.",
        "UI supports pagination controls and the backend supports paged queries (limit/offset or cursor)."
      ],
      "file_operations": [
        {
          "path": "frontend/src/pages/LeaderboardPage.tsx",
          "operation": "create",
          "description": "Create a leaderboard page per competition that loads getLeaderboard, filters to completed results, computes Ao5 client-side, sorts with DNF last, displays ranking, and provides pagination controls (client-side slicing now, designed to swap to server paging later). Verify the component's usage instructions before implementing."
        },
        {
          "path": "frontend/src/lib/ao5.ts",
          "operation": "create",
          "description": "Implement Ao5 calculation utilities (drop best/worst; handle DNF consistently and return a comparable sort key + display formatting). Verify the component's usage instructions before implementing."
        },
        {
          "path": "frontend/src/components/leaderboard/LeaderboardTable.tsx",
          "operation": "create",
          "description": "Create a table component for ranked leaderboard rows (rank, competitor display name, Ao5, attempt breakdown) using shadcn-ui table primitives from frontend/src/components/ui (do not modify them). Verify the component's usage instructions before implementing."
        },
        {
          "path": "frontend/src/hooks/useLeaderboard.ts",
          "operation": "create",
          "description": "Add a React Query hook for getLeaderboard with stable query keys, optional pagination parameters in the hook signature for future server paging, and derived loading/error state for the UI. Verify the component's usage instructions before implementing."
        },
        {
          "path": "frontend/src/router.tsx",
          "operation": "modify",
          "description": "Register the leaderboard route under the competition context and link to it from competition detail and completion screen. Verify the component's usage instructions before implementing."
        }
      ]
    },
    {
      "id": "REQ-8",
      "summary": "Add solve-session UX safeguards: dark minimal solve UI, dominant timer/scramble, unload warning, and navigation blocking during in-progress sessions.",
      "acceptanceCriteria": [
        "Timer is visually dominant (large font) and legible on a dark theme.",
        "When a session is in progress, the app shows a browser unload warning on refresh/close (where supported).",
        "The app intercepts in-app navigation away from the solve flow and asks for confirmation while in progress.",
        "Users cannot use in-app controls to navigate to previous scrambles/attempts."
      ],
      "file_operations": [
        {
          "path": "frontend/src/hooks/useBeforeUnloadWarning.ts",
          "operation": "create",
          "description": "Implement a hook that registers a beforeunload handler when a solve session is in progress to warn on refresh/close (where supported). Verify the component's usage instructions before implementing."
        },
        {
          "path": "frontend/src/hooks/useNavigationBlocker.tsx",
          "operation": "create",
          "description": "Implement an in-app navigation confirmation mechanism (router-aware) that prompts when leaving the solve flow during an active session, within browser limitations. Verify the component's usage instructions before implementing."
        },
        {
          "path": "frontend/src/pages/SolveFlowPage.tsx",
          "operation": "modify",
          "description": "Integrate unload warning + navigation blocking hooks; ensure no in-app UI provides links to prior attempts and hide/disable non-essential navigation elements during active timing. Verify the component's usage instructions before implementing."
        },
        {
          "path": "frontend/src/components/layout/AppShell.tsx",
          "operation": "create",
          "description": "Create a layout that can switch into a minimal 'focus mode' for solve routes (e.g., reduced header/navigation) while keeping consistent styling elsewhere. Use shadcn-ui layout primitives as needed from frontend/src/components/ui (do not modify them). Verify the component's usage instructions before implementing."
        }
      ]
    },
    {
      "id": "REQ-9",
      "summary": "Apply a consistent dark, minimal visual theme across the app with a non-blue/non-purple primary accent and consistent component styling.",
      "acceptanceCriteria": [
        "All primary surfaces, text, and interactive elements follow a consistent dark theme style guide.",
        "Primary accent color is not blue or purple.",
        "Buttons, cards, typography scale, and form fields look consistent across competition pages, solve flow, and leaderboard."
      ],
      "file_operations": [
        {
          "path": "frontend/src/index.css",
          "operation": "create",
          "description": "Add the missing CSS entrypoint imported by frontend/src/main.tsx; include Tailwind directives and define dark theme CSS variables with a non-blue/non-purple primary accent, aligning with existing Tailwind variable-based color system. Verify the component's usage instructions before implementing."
        },
        {
          "path": "frontend/src/App.tsx",
          "operation": "modify",
          "description": "Ensure the app runs in dark mode by default (apply the 'dark' class at the root) and apply consistent typography/spacing via a shared layout wrapper. Verify the component's usage instructions before implementing."
        },
        {
          "path": "frontend/src/components/design/typography.ts",
          "operation": "create",
          "description": "Centralize common typography/formatting helpers (e.g., headings, muted text classes) used across pages to keep styling consistent without introducing new global stylesheet paths. Verify the component's usage instructions before implementing."
        }
      ]
    },
    {
      "id": "REQ-10",
      "summary": "Organize the frontend data layer (React Query) and UI code to support future multi-event competitions and future payments/webhooks without implementing payments now.",
      "acceptanceCriteria": [
        "Competition data model includes an event identifier or event type field suitable for multiple events (even if UI defaults to one event).",
        "Code organization separates competition metadata, participation, and result submission logic to make future extensions straightforward.",
        "No payment collection or external webhook integrations are implemented in this build."
      ],
      "file_operations": [
        {
          "path": "frontend/src/api/queryKeys.ts",
          "operation": "create",
          "description": "Define centralized React Query keys for competitions, profiles, results, and leaderboards to keep cache invalidation and future feature additions consistent. Verify the component's usage instructions before implementing."
        },
        {
          "path": "frontend/src/api/errors.ts",
          "operation": "create",
          "description": "Add a small error-normalization layer to translate backend trap messages/variants into user-facing English messages, keeping future paid/webhook-related errors isolated from UI components. Verify the component's usage instructions before implementing."
        },
        {
          "path": "frontend/src/types/domain.ts",
          "operation": "create",
          "description": "Create frontend domain types/helpers (including an explicit event identifier/type used by the admin create form and displayed in competition info) without introducing payment concepts or webhook code. Verify the component's usage instructions before implementing."
        },
        {
          "path": "frontend/src/pages/CompetitionsListPage.tsx",
          "operation": "create",
          "description": "Create a public competitions list page (single place to browse competitions) and keep it event-ready by displaying an event label (defaulting to the current event); do not implement payments. Verify the component's usage instructions before implementing."
        },
        {
          "path": "frontend/src/router.tsx",
          "operation": "modify",
          "description": "Wire the competitions list as the main public browsing route and ensure all other pages are reachable via navigation; avoid adding unrelated top-level pages. Verify the component's usage instructions before implementing."
        }
      ]
    }
  ]
}