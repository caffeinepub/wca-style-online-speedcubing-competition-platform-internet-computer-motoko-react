{
  "kind": "build_request",
  "title": "Fix SolveFlow refresh auto-DNF advancement so users continue from the correct next attempt",
  "priority": "high",
  "requirements": [
    {
      "id": "REQ-123",
      "text": "Fix solve-session refresh recovery so that when a user refreshes during attempt N, the backend marks attempt N as DNF and advances `currentAttempt` to N+1; after reload, the solve flow must resume on the next attempt (not restart at attempt 1) and must not allow re-solving an already-DNF’d attempt index.",
      "target": "both",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "This attempt was marked DNF because the page was refreshed. Continuing with attempt 1.\nfiest solve completed and i refresh on second still on first after refresh and when i try to do again it says but it didnt move to 2 nd as first is dnf."
        ]
      },
      "acceptanceCriteria": [
        "Given attempt 1 is completed, if the user refreshes during attempt 2, the backend persists attempt 2 as DNF and sets the next eligible attempt to attempt 3.",
        "After the refresh, the SolveFlow UI shows “Attempt 3 of 5” (not “Attempt 1 of 5”).",
        "After the refresh, the user is shown the scramble for the next eligible attempt (e.g., attempt 3) and cannot re-run attempt 2 timing or submit another solve for attempt 2.",
        "The backend prevents duplicate/overwrite submissions for any attempt index that already has a stored non-zero time or a stored DNF marker, including the auto-DNF case.",
        "If the user refreshes during attempt 1 before any successful submission, attempt 1 is marked DNF and the UI resumes at attempt 2.",
        "All user-facing messaging for this scenario is English-only and clearly indicates which attempt was marked DNF and which attempt the user will continue with."
      ]
    },
    {
      "id": "REQ-124",
      "text": "Update SolveFlowPage refresh messaging and attempt index display so it never shows an incorrect attempt number (e.g., “Continuing with attempt 1”) when the backend has advanced the session; the message must reflect the actual 1-based attempt number that the user should do next.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "This attempt was marked DNF because the page was refreshed. Continuing with attempt 1."
        ]
      },
      "acceptanceCriteria": [
        "When the backend indicates an auto-DNF advancement occurred, the UI shows an English message in the form: “Attempt <N> was marked DNF because the page was refreshed. Continuing with attempt <N+1>.”",
        "The attempt number shown in the page header (e.g., “Attempt X of 5”) matches the server-reported next attempt index + 1.",
        "No toast/banner/message claims the app is continuing with attempt 1 unless the next eligible attempt is actually attempt 1.",
        "The UI does not silently fail; the user always sees either the correct resumed attempt screen or a clear English error state routed via existing error normalization (`normalizeError`) where applicable."
      ]
    }
  ],
  "constraints": [
    "Backend must remain a single Motoko actor; all logic stays in backend/main.mo.",
    "Only add backend migration (backend/migration.mo) if required by persisted state changes (follow the conditional migration policy).",
    "Do not edit any frontend paths listed as immutable in SYSTEM_CONTEXT.",
    "Use English for all user-facing text."
  ],
  "nonGoals": [
    "Changing WCA inspection penalty rules beyond ensuring refresh recovery uses the correct attempt advancement.",
    "Adding new competition/payment/admin features unrelated to solve-flow refresh recovery."
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  },
  "userProfileUpdate": {
    "goalsToAdd": [],
    "goalsToRemove": [],
    "preferencesToAdd": [
      "All user-facing text should be English-only."
    ],
    "preferencesToRemove": [],
    "miscToAdd": [],
    "miscToRemove": [],
    "fieldsToSet": {},
    "fieldsToDelete": []
  }
}